---
sidebar: sidebar 
permalink: concept_stor_hwraid_local.html 
keywords: ontap select, hardware raid, performance boost, protection 
summary: 當硬體 RAID 控制器可用時， ONTAP Select可以將 RAID 服務移轉到硬體控制器，以提升寫入效能並防止實體磁碟機故障。因此， ONTAP Select叢集中所有節點的 RAID 保護均由本機連接的 RAID 控制器提供，而非透過ONTAP軟體 RAID 提供。 
---
= 適用於ONTAP Select本機連線儲存的硬體 RAID 服務
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
當硬體 RAID 控制器可用時， ONTAP Select可以將 RAID 服務移轉到硬體控制器，以提升寫入效能並防止實體磁碟機故障。因此， ONTAP Select叢集中所有節點的 RAID 保護均由本機連接的 RAID 控制器提供，而非透過ONTAP軟體 RAID 提供。


NOTE: ONTAP Select資料聚合配置為使用 RAID 0，因為實體 RAID 控制器正在為底層磁碟機提供 RAID 條帶化功能。不支援其他 RAID 等級。



== 本機連接儲存的 RAID 控制器配置

所有為ONTAP Select提供後備儲存的本機連線磁碟都必須位於 RAID 控制器後面。大多數商用伺服器提供多種 RAID 控制器選項，涵蓋多個價位，每個選項的功能等級各不相同。我們的目標是盡可能支援這些選項，前提是它們滿足控制器的特定最低要求。


NOTE: 您無法從使用硬體 RAID 配置的ONTAP Select虛擬機器中分離虛擬磁碟。僅支援從使用軟體 RAID 配置的ONTAP Select虛擬機器中分離磁碟。看link:task_adm_replace_drives_swraid.html["更換ONTAP Select軟體 RAID 配置中的故障磁碟機"]了解更多。

管理ONTAP Select磁碟的 RAID 控制器必須符合以下要求：

* 硬體 RAID 控制器必須具有電池備用單元 (BBU) 或快閃記憶體支援寫入快取 (FBWC) 並支援 12Gbps 的吞吐量。
* RAID 控制器必須支援能夠承受至少一個或兩個磁碟故障的模式（RAID 5 和 RAID 6）。
* 必須將驅動器快取設定為停用。
* 必須將寫入策略配置為寫回模式，並在 BBU 或快閃記憶體發生故障時回退到寫入模式。
* 必須將讀取的 I/O 策略設定為快取。


所有為ONTAP Select提供後備儲存的本機連線磁碟都必須放入執行 RAID 5 或 RAID 6 的 RAID 群組中。對於 SAS 磁碟機和 SSD，使用最多 24 個磁碟機的 RAID 群組可使ONTAP受益於將傳入的讀取要求分散到更多磁碟上。這樣做可以顯著提升效能。對於 SAS/SSD 配置，我們針對單一 LUN 和多 LUN 配置進行了效能測試。未發現顯著差異，因此，為簡單起見， NetApp建議建立滿足配置需求所需的最少數量的 LUN。

NL-SAS 和 SATA 硬碟需要一套不同的最佳實務。出於效能考慮，磁碟的最小數量仍然為 8 個，但 RAID 群組大小不應超過 12 個磁碟機。 NetApp也建議每個 RAID 群組使用一個備用磁碟；不過，所有 RAID 群組都可以使用全域備用磁碟。例如，每三個 RAID 群組可以使用兩個備用磁碟，每個 RAID 群組包含 8 到 12 個磁碟機。


NOTE: 舊版 ESX 的最大範圍和資料儲存大小為 64 TB，這會影響支援這些大容量磁碟機提供的總原始容量所需的 LUN 數量。



== RAID模式

許多 RAID 控制器支援最多三種操作模式，每種模式都代表寫入請求所採用的資料路徑的顯著差異。這三種模式如下：

* 直寫。所有傳入的 I/O 請求都寫入 RAID 控制器緩存，然後立即刷新到磁碟，然後再向主機確認該請求。
* 繞寫。所有傳入的 I/O 請求都直接寫入磁碟，繞過 RAID 控制器快取。
* 寫回。所有傳入的 I/O 請求都直接寫入控制器緩存，並立即返回主機確認。資料塊透過控制器異步刷新到磁碟。


回寫模式提供最短的資料路徑，資料塊進入快取後立即進行 I/O 確認。此模式為混合讀取/寫入工作負載提供最低的延遲和最高的吞吐量。然而，如果沒有 BBU 或非揮發性快閃技術，系統在此模式下運作時如果發生電源故障，使用者將面臨遺失資料的風險。

ONTAP Select需要配備備用電池或快閃記憶體單元；因此，我們可以確保在發生此類故障時，快取的區塊會刷新到磁碟。因此，要求將 RAID 控制器配置為寫回模式。



== ONTAP Select與作業系統之間共用的本機磁碟

最常見的伺服器配置是所有本機連接的磁碟軸都位於單一 RAID 控制器後面。您應該至少配置兩個 LUN：一個用於虛擬機器管理程序，一個用於ONTAP Select虛擬機。

例如，假設一台 HP DL380 g8 配備六個內建硬碟和一個 Smart Array P420i RAID 控制器。所有內建硬碟均由該 RAID 控制器管理，系統中沒有其他儲存設備。

下圖顯示了這種配置方式。在此範例中，系統上沒有其他儲存；因此，虛擬機器管理程式必須與ONTAP Select節點共用儲存。

*僅具有 RAID 管理主軸的伺服器 LUN 設定*

image:ST_08.jpg["僅具有 RAID 管理主軸的伺服器 LUN 配置"]

透過與ONTAP Select相同的 RAID 群組配置作業系統 LUN，虛擬機器管理程式作業系統（以及同樣從該儲存配置的任何用戶端虛擬機器）可受益於 RAID 保護。此配置可防止單一磁碟機故障導致整個系統崩潰。



== 本機磁碟在ONTAP Select和 OS 之間分配

伺服器供應商提供的另一種可能的配置是使用多個 RAID 或磁碟控制器配置系統。在這種配置中，一組磁碟由磁碟控制器管理，該控制器可能提供或不提供 RAID 服務。另一組磁碟由一個硬體 RAID 控制器管理，該控制器能夠提供 RAID 5/6 服務。

採用此配置方式，位於 RAID 控制器後方、可提供 RAID 5/6 服務的磁碟軸組應由ONTAP Select虛擬機器獨佔使用。根據管理的總儲存容量，您應該將磁碟軸配置為一個或多個 RAID 群組以及一個或多個 LUN。然後，這些 LUN 將用於建立一個或多個資料儲存庫，所有資料儲存庫均受 RAID 控制器保護。

第一組磁碟保留給虛擬機管理程式作業系統和任何未使用ONTAP儲存的客戶端虛擬機，如下圖所示。

*混合 RAID/非 RAID 系統上的伺服器 LUN 設定*

image:ST_09.jpg["混合 RAID/非 RAID 系統上的伺服器 LUN 配置"]



== 多個 LUN

有兩種情況必須更改單一 RAID 群組/單 LUN 配置。使用 NL-SAS 或 SATA 磁碟機時，RAID 群組大小不得超過 12 個磁碟機。此外，單一 LUN 的大小可能會超過底層虛擬機器管理程式的儲存限制（單一檔案系統擴充區最大大小或總儲存池最大大小）。這時，必須將底層實體儲存拆分為多個 LUN，才能成功建立檔案系統。



== VMware vSphere 虛擬機器檔案系統限制

某些版本的 ESX 上資料儲存的最大大小為 64TB。

如果伺服器連接的儲存空間超過 64 TB，則可能需要設定多個 LUN，每個 LUN 的容量都小於 64 TB。建立多個 RAID 群組以縮短 SATA/NL-SAS 磁碟機的 RAID 重建時間也會導致配置多個 LUN。

當需要多個 LUN 時，需要考慮的重點是確保這些 LUN 具有相似且一致的效能。如果所有 LUN 都用於單一ONTAP聚合，這一點尤其重要。或者，如果一個或多個 LUN 的子集具有明顯不同的效能配置文件，我們強烈建議將這些 LUN 隔離到單獨的ONTAP聚合中。

可以使用多個檔案系統擴充區來建立單一資料儲存庫，最大可達資料儲存庫的最大大小。若要限制需要ONTAP Select許可證的容量，請務必在叢集安裝期間指定容量上限。此功能允許ONTAP Select僅使用資料儲存庫中的一部分空間（因此需要許可證）。

或者，也可以先在單一 LUN 上建立單一資料儲存庫。當需要更大容量的ONTAP Select授權來增加空間時，可以將該空間作為擴充區新增至相同資料儲存庫，直到達到資料儲存庫的最大大小。達到最大大小後，可以建立新的資料儲存庫並將其新增至ONTAP Select。兩種容量擴展操作均受支持，並且可以透過使用ONTAP Deploy 的儲存添加功能來實現。每個ONTAP Select節點可以配置為支援高達 400 TB 的儲存容量。從多個資料儲存庫配置容量需要兩個步驟。

初始叢集建立可用於建立使用初始資料儲存庫中部分或全部空間的ONTAP Select叢集。第二步是使用其他資料儲存庫執行一個或多個容量添加操作，直到達到所需的總容量。此功能在「此部分」中有詳細介紹。link:concept_stor_capacity_inc.html["增加儲存容量"] 。


NOTE: VMFS 開銷不為零（請參閱 VMware KB 1001618），嘗試使用資料儲存報告的整個可用空間會導致叢集建立作業期間出現虛假錯誤。

每個資料存儲庫中都有 2% 的緩衝區未使用。此空間不需要容量許可證，因為ONTAP Select不使用它。只要未指定容量上限， ONTAP Deploy 就會自動計算緩衝區的準確 GB 數。如果指定了容量上限，則首先強制執行該大小。如果容量上限大小在緩衝區大小範圍內，則叢集建立將會失敗，並顯示錯誤訊息，其中指定了可用作容量上限的正確最大大小參數：

[listing]
----
“InvalidPoolCapacitySize: Invalid capacity specified for storage pool “ontap-select-storage-pool”, Specified value: 34334204 GB. Available (after leaving 2% overhead space): 30948”
----
VMFS 6 既支援新安裝，也支援作為現有ONTAP Deploy 或ONTAP Select VM 的 Storage vMotion 作業的目標。

VMware 不支援從 VMFS 5 到 VMFS 6 的就地升級。因此，Storage vMotion 是唯一允許任何虛擬機器從 VMFS 5 資料儲存過渡到 VMFS 6 資料儲存的機制。但是，除了從 VMFS 5 過渡到 VMFS 6 這一特定目的之外， ONTAP Select和ONTAP Deploy 對 Storage vMotion 的支援已擴展至涵蓋其他場景。



== ONTAP Select虛擬磁碟

ONTAP Select 的核心是為ONTAP提供一組從一個或多個儲存池配置的虛擬磁碟。 ONTAPONTAP取得一組虛擬磁碟，並將其視為實體磁碟，而儲存堆疊的其餘部分則由虛擬機器管理程式抽象化。下圖更詳細地展示了這種關係，突顯了實體 RAID 控制器、虛擬機器管理程式和ONTAP Select虛擬機器之間的關係。

* RAID 群組和 LUN 的設定在伺服器的 RAID 控制器軟體中進行。使用 VSAN 或外部陣列時，無需進行此配置。
* 儲存池配置在虛擬機器管理程式內部進行。
* 虛擬磁碟由各個虛擬機器建立和擁有；在此範例中，由ONTAP Select建立和擁有。


*虛擬磁碟到實體磁碟的映射*

image:ST_12.jpg["虛擬磁碟到實體磁碟的映射"]



== 虛擬磁碟配置

為了提供更簡化的使用者體驗， ONTAP Select管理工具ONTAP Deploy 會自動從關聯的儲存池配置虛擬磁碟，並將其連接到ONTAP Select虛擬機器。此操作在初始設定和儲存新增操作期間都會自動執行。如果ONTAP Select節點屬於 HA 對，則虛擬磁碟會自動指派給本機和鏡像儲存池。

ONTAP Select會將底層連接的儲存分割成大小相等的虛擬磁碟，每個虛擬磁碟的容量不超過 16 TB。如果ONTAP Select節點屬於 HA 對，則係統會在每個叢集節點上建立至少兩個虛擬磁碟，並將其指派給本機叢和鏡像叢，以便在鏡像聚合中使用。

例如，可以為ONTAP Select分配一個 31 TB 的資料儲存或 LUN（即部署虛擬機器並配置系統磁碟和根磁碟後剩餘的空間）。然後，建立四個約 7.75 TB 的虛擬磁碟，並將其指派給對應的ONTAP本機 Plex 和映像 Plex。


NOTE: 在ONTAP Select虛擬機器中新增容量可能會導致 VMDK 大小不同。詳情請參閱該部分link:concept_stor_capacity_inc.html["增加儲存容量"]。與FAS系統不同，不同大小的 VMDK 可以存在於同一聚合中。在這些 VMDK 中使用 RAID 0 條帶，這樣就可以充分利用每個 VMDK 中的所有空間，無論其大小如何。



== 虛擬化NVRAM

NetApp FAS系統傳統上配備實體NVRAM PCI 卡，這是一種包含非揮發性快閃記憶體的高效能卡。該卡使ONTAP能夠立即向客戶端確認傳入的寫入操作，從而顯著提升寫入效能。它還可以安排將已修改的資料塊移回速度較慢的儲存介質，這個過程稱為「降級暫存」。

商用系統通常不配備此類設備。因此，此NVRAM卡的功能已被虛擬化並放置在ONTAP Select系統啟動磁碟的一個分割區中。正因如此，實例的系統虛擬磁碟的放置位置至關重要。這也是為什麼該產品需要配備具有彈性快取的實體 RAID 控制器，以用於本地連接儲存配置。

NVRAM位於其自己的 VMDK 上。將NVRAM分割到自己的 VMDK 中，可使ONTAP Select虛擬機器使用 vNVMe 驅動程式與其NVRAM VMDK 通訊。此外，也要求ONTAP Select虛擬機器使用硬體版本 13，該版本與 ESX 6.5 及更高版本相容。



== 資料路徑解釋： NVRAM和 RAID 控制器

透過遍歷寫入請求進入系統時所採用的資料路徑，可以最好地突出顯示虛擬化NVRAM系統分區和 RAID 控制器之間的交互。

傳入ONTAP Select虛擬機器的寫入要求會以虛擬機器的NVRAM分區為目標。在虛擬化層，此分割區位於ONTAP Select系統磁碟（即連接到ONTAP Select虛擬機器的 VMDK）內。在實體層，這些請求會快取在本機 RAID 控制器中，就像所有針對底層磁碟軸的區塊變更一樣。從這裡，寫入操作會回傳給主機確認。

此時，物理上，該區塊駐留在 RAID 控制器快取中，等待刷新到磁碟。邏輯上，該區塊駐留在NVRAM中，等待降級到對應的用戶資料磁碟。

由於變更的區塊會自動儲存在 RAID 控制器的本機快取中，因此傳入NVRAM分割區的寫入作業也會自動快取並定期刷新到實體儲存媒體。請勿將此與定期將NVRAM內容刷新回ONTAP資料磁碟的操作混淆。這兩個事件互不相關，發生的時間和頻率也不同。

下圖展示了傳入寫入所採用的 I/O 路徑。它突出顯示了實體層（由 RAID 控制器快取和磁碟表示）與虛擬層（由虛擬機器的NVRAM和資料虛擬磁碟表示）之間的差異。


NOTE: 雖然NVRAM VMDK 上變更的區塊會快取在本機 RAID 控制器快取中，但該快取無法感知虛擬機器結構或其虛擬磁碟。它會儲存系統上所有已更改的區塊，而NVRAM只是其中的一部分。這包括發送到虛擬機器管理程式的寫入請求（前提是虛擬機器管理程式是從相同的備用主軸配置的）。

*傳入ONTAP Select VM 的寫入*

image:ST_13.jpg["傳入ONTAP Select VM 的寫入"]


NOTE: NVRAM分區在其自己的 VMDK 上獨立存在。此 VMDK 使用 ESX 6.5 或更高版本中提供的 vNVME 驅動程式進行連線。此變更對於使用軟體 RAID 的ONTAP Select安裝最為重要，因為此類安裝無法從 RAID 控制器快取中獲益。
