---
sidebar: sidebar 
permalink: concept_stor_vsan_external.html 
keywords: ontap select, vsan and external array configurations, vnas architecture 
summary: '虛擬 NAS (vNAS) 部署支援 vSAN 上的ONTAP Select叢集、一些 HCI 產品、 NetApp HCI技術以及外部陣列類型的資料儲存。這些配置的底層基礎架構提供了資料儲存的彈性。' 
---
= ONTAP SelectvSAN 和外部陣列配置
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
虛擬 NAS (vNAS) 部署支援虛擬 SAN (vSAN) 上的ONTAP Select叢集、一些 HCI 產品以及外部陣列類型的資料儲存。這些配置的底層基礎架構提供了資料儲存的彈性。

最低要求是您使用的虛擬機器管理程式（在支援的 Linux 主機上執行的 VMware ESXi 或 KVM）支援底層配置。如果虛擬機器管理程式是 ESXi，則應將其列入對應的 VMware 硬體相容性清單 (HCL) 中。



== vNAS 架構

vNAS 命名法適用於所有不使用 DAS 的設定。對於多節點ONTAP Select集群，這包括同一 HA 對中的兩個ONTAP Select節點共享單一資料儲存庫（包括 vSAN 資料儲存庫）的架構。這些節點也可以安裝在同一共用外部陣列的不同資料儲存庫上。這樣可以提高陣列端儲存效率，從而減少整個ONTAP Select HA 對的整體佔用空間。 ONTAPONTAP Select vNAS 解決方案的架構與具有本機 RAID 控制器的 DAS 上的ONTAP Select架構非常相似。也就是說，每個ONTAP Select節點都會繼續擁有其 HA 夥伴節點資料的副本。 ONTAP儲存效率策略是節點範圍的。因此，陣列端儲存效率是可取的，因為它們可以應用於來自兩個ONTAP Select節點的資料集。

HA 對中的每個ONTAP Select節點也可能使用單獨的外部陣列。將ONTAP Select Metrocluster SDS 與外部儲存結合使用時，這是常見的選擇。

當為每個ONTAP Select節點使用單獨的外部陣列時，兩個陣列為ONTAP Select VM 提供相似的效能特徵非常重要。



=== vNAS 架構與配備硬體 RAID 控制器的本機 DAS

從邏輯上講，vNAS 架構與配備 DAS 和 RAID 控制器的伺服器架構最相似。在這兩種情況下， ONTAP Select都會佔用資料儲存空間。此資料儲存空間被劃分為 VMDK，這些 VMDK 構成傳統的ONTAP資料聚合。在叢集建立和儲存新增作業期間， ONTAP Deploy 會確保 VMDK 的大小正確，並指派給正確的叢（對於 HA 對）。

vNAS 與配備 RAID 控制器的 DAS 之間有兩個主要區別。最直接的區別是 vNAS 不需要 RAID 控制器。 vNAS 假設底層外部陣列能夠提供配備 RAID 控制器的 DAS 所提供的資料持久性和彈性。第二個更細微的差異與NVRAM效能有關。



== vNAS NVRAM

ONTAP Select NVRAM是一種 VMDK。這意味著ONTAP Select在區塊尋址設備 (VMDK) 之上模擬位元組尋址空間 (傳統NVRAM)。然而， NVRAM的效能對於ONTAP Select節點的整體效能至關重要。

對於具有硬體 RAID 控制器的 DAS 設置，硬體 RAID 控制器快取充當NVRAM緩存，因為對NVRAM VMDK 的所有寫入都首先託管在 RAID 控制器快取中。

對於 VNAS 架構， ONTAP Deploy 會自動使用名為「單一實例資料日誌記錄 (SIDL)」的啟動參數來設定ONTAP Select節點。當此啟動參數存在時， ONTAP Select會繞過NVRAM ，將資料負載直接寫入資料聚合。 NVRAMNVRAM用於記錄 WRITE 操作變更的區塊的位址。此功能的優點在於避免了雙重寫入：一次寫入NVRAM ，另一次寫入NVRAM降級後。此功能僅適用於 vNAS，因為本地寫入 RAID 控制器快取的額外延遲可以忽略不計。

SIDL 功能並非與所有ONTAP Select儲存效率功能相容。可以使用以下命令在聚合層級停用 SIDL 功能：

[listing]
----
storage aggregate modify -aggregate aggr-name -single-instance-data-logging off
----
請注意，如果關閉 SIDL 功能，寫入效能會受到影響。停用該聚合中所有磁碟區上的所有儲存效率策略後，可以重新啟用 SIDL 功能：

[listing]
----
volume efficiency stop -all true -vserver * -volume * (all volumes in the affected aggregate)
----


== 在 ESXi 上使用 vNAS 時並置ONTAP Select節點

ONTAP Select支援在共用儲存上部署多節點ONTAP Select叢集。 ONTAPONTAP支援在同一 ESX 主機上配置多個ONTAP Select節點，前提是這些節點不屬於同一叢集。請注意，此配置僅適用於 VNAS 環境（共用資料儲存）。使用 DAS 儲存時，不支援每個主機部署多個ONTAP Select實例，因為這些實例會爭用相同硬體 RAID 控制器。

ONTAP Deploy 確保多節點 VNAS 叢集的初始部署不會將來自相同叢集的多個ONTAP Select實例放置在同一台主機上。下圖展示了兩個四節點叢集在兩台主機上交叉部署的正確範例。

多節點 VNAS 叢集的初始部署

image:ST_14.jpg["多節點 VNAS 叢集的初始部署"]

部署後， ONTAP Select節點可以在主機之間遷移。這可能會導致配置不理想且不受支持，因為同一叢集中的兩個或多個ONTAP Select節點共用同一底層主機。 NetApp建議手動建立虛擬機器反關聯性規則，以便 VMware 自動維護同一叢集中節點之間的實體隔離，而不僅僅是同一 HA 對中的節點之間的實體隔離。


NOTE: 反親和性規則要求在 ESX 叢集上啟用 DRS。

請參閱以下範例，以了解如何為ONTAP Select虛擬機器建立反關聯性規則。如果ONTAP Select叢集包含多個 HA 對，則叢集中的所有節點都必須包含在此規則中。

image:ST_15.jpg["虛擬機器/主機規則"]

image:ST_16.jpg["編輯虛擬機器/主機規則"]

由於以下原因之一，同一ONTAP Select叢集中的兩個或多個ONTAP Select節點可能會位於同一 ESX 主機上：

* 由於 VMware vSphere 授權限製或未啟用 DRS，因此不存在 DRS。
* 由於 VMware HA 操作或管理員啟動的 VM 遷移優先，因此 DRS 反親和性規則被繞過。


請注意， ONTAP Deploy 不會主動監控ONTAP Select虛擬機器的位置。但是，叢集刷新操作會在ONTAP Deploy 日誌中反映此不受支援的配置：

image:ST_17.PNG["ONTAP Deploy 日誌"]
